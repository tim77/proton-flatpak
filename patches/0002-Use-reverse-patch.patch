From ee97fd63e69068cba6ee3d6df539d02676399216 Mon Sep 17 00:00:00 2001
From: gasinvein <gasinvein@gmail.com>
Date: Sun, 19 Apr 2020 14:37:51 +0300
Subject: [PATCH 2/2] Use reverse patch

---
 patches/protonprep.sh                         |  2 +-
 .../0001-winepath-Build-with-msvcrt.patch     | 68 +++++++++++++++++++
 2 files changed, 69 insertions(+), 1 deletion(-)
 create mode 100644 patches/wine-hotfixes/0001-winepath-Build-with-msvcrt.patch

diff --git a/patches/protonprep.sh b/patches/protonprep.sh
index e0bdfcf..0b37868 100755
--- a/patches/protonprep.sh
+++ b/patches/protonprep.sh
@@ -68,7 +68,7 @@
     cd wine
 
     # winepath was broken with this commit
-    git revert --no-commit e22bcac706be3afac67f4faac3aca79fd67c3d6f
+    patch -Np1 -R ../patches/wine-hotfixes/0001-winepath-Build-with-msvcrt.patch
 
 # Enable these for now in favor over proton gamepad additions
 #    -W dinput-SetActionMap-genre \
diff --git a/patches/wine-hotfixes/0001-winepath-Build-with-msvcrt.patch b/patches/wine-hotfixes/0001-winepath-Build-with-msvcrt.patch
new file mode 100644
index 0000000..a102885
--- /dev/null
+++ b/patches/wine-hotfixes/0001-winepath-Build-with-msvcrt.patch
@@ -0,0 +1,68 @@
+From e22bcac706be3afac67f4faac3aca79fd67c3d6f Mon Sep 17 00:00:00 2001
+From: Alexandre Julliard <julliard@winehq.org>
+Date: Thu, 9 Apr 2020 09:43:30 +0200
+Subject: [PATCH] winepath: Build with msvcrt.
+
+Signed-off-by: Alexandre Julliard <julliard@winehq.org>
+---
+ programs/winepath/Makefile.in |  3 ++-
+ programs/winepath/winepath.c  | 15 +++------------
+ 2 files changed, 5 insertions(+), 13 deletions(-)
+
+diff --git a/programs/winepath/Makefile.in b/programs/winepath/Makefile.in
+index 16b5627aa5..58a9acdc9e 100644
+--- a/programs/winepath/Makefile.in
++++ b/programs/winepath/Makefile.in
+@@ -1,5 +1,6 @@
+ MODULE    = winepath.exe
+-APPMODE   = -mconsole -municode
++
++EXTRADLLFLAGS = -mconsole -municode -mno-cygwin
+ 
+ C_SRCS = winepath.c
+ 
+diff --git a/programs/winepath/winepath.c b/programs/winepath/winepath.c
+index 7f4cd978d5..81944829dd 100644
+--- a/programs/winepath/winepath.c
++++ b/programs/winepath/winepath.c
+@@ -21,9 +21,6 @@
+  */
+ 
+ #define WIN32_LEAN_AND_MEAN
+-
+-#include "config.h"
+-
+ #include <windows.h>
+ #include <stdio.h>
+ #include <stdlib.h>
+@@ -92,13 +89,7 @@ static int option(int shortopt, const WCHAR *longopt)
+  */
+ static int parse_options(WCHAR *argv[])
+ {
+-    static const WCHAR longW[] = { 'l','o','n','g',0 };
+-    static const WCHAR shortW[] = { 's','h','o','r','t',0 };
+-    static const WCHAR unixW[] = { 'u','n','i','x',0 };
+-    static const WCHAR windowsW[] = { 'w','i','n','d','o','w','s',0 };
+-    static const WCHAR helpW[] = { 'h','e','l','p',0 };
+-    static const WCHAR nullW[] = { 0 };
+-    static const WCHAR *longopts[] = { longW, shortW, unixW, windowsW, helpW, nullW };
++    static const WCHAR *longopts[] = { L"long", L"short", L"unix", L"windows", L"help", NULL };
+     int outputformats = 0;
+     BOOL done = FALSE;
+     int i, j;
+@@ -117,10 +108,10 @@ static int parse_options(WCHAR *argv[])
+                 done = TRUE;
+             } else {
+                 /* long option */
+-                for (j = 0; longopts[j][0]; j++)
++                for (j = 0; longopts[j]; j++)
+                     if (!lstrcmpiW(argv[i]+2, longopts[j]))
+                         break;
+-                outputformats |= option(longopts[j][0], argv[i]);
++                if (longopts[j]) outputformats |= option(longopts[j][0], argv[i]);
+             }
+         } else {
+             /* short options */
+-- 
+2.25.3
+
-- 
2.25.3

